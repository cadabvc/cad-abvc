<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CAD ABVC - Conselho de Arbitragem</title>

<!-- Supabase Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase Init (Nova Versão Corrigida) -->
<script>
  const SUPABASE_URL = 'https://prwhifyewscielsopluj.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByd2hpZnlld3NjaWVsc29wbHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzA2MzEsImV4cCI6MjA3ODYwNjYzMX0.N8Op_2iUwRFd71YTninoztaInQtVLEnVIwbi2nIHkKg';

  if (!window.supabase || typeof window.supabase.createClient !== 'function') {
    console.error('Supabase JS library not loaded correctly.');
  } else {
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
</script>

<style>
/* estilos mantidos */
</style>
</head>
<body>

<nav>
  <a onclick="showSection('home')">Home</a>
  <a onclick="showSection('dispensas')">Dispensas</a>
  <a onclick="showSection('recibos')">Recibos</a>
  <a onclick="showSection('comunicados')">Comunicados</a>
  <a onclick="showSection('calendario')">Calendário ABVC</a>
  <a onclick="showSection('contactos')">Contactos</a>
</nav>

<div class="container">
  <!-- HOME -->
  <section id="home" class="active">
    <img src="abvc_cad.png" alt="AB Viana do Castelo" class="home-img">
    <h2>Bem-vindo ao CAD da ABVC</h2>
    <p>Use o menu para registar dispensas, submeter recibos e consultar o calendário.</p>
  </section>

  <!-- DISPENSAS -->
  <section id="dispensas">
    <h2>Registo de Dispensas</h2>
    <form id="dispensaForm">
      <label>Nome</label>
      <input type="text" id="nomeDispensa" required>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <label>Data Inicial</label>
          <input type="date" id="dataInicio" required>
        </div>
        <div>
          <label>Data Final</label>
          <input type="date" id="dataFim" required>
        </div>
      </div>

      <label>Período</label>
      <select id="periodo" required>
        <option value="Integral">Integral</option>
        <option value="Manhã">Parte da Manhã</option>
        <option value="Tarde">Parte da Tarde</option>
        <option value="Noite">Parte da Noite</option>
      </select>

      <label>Motivo (opcional)</label>
      <textarea id="motivo"></textarea>

      <button type="button" onclick="enviarDispensa()">Enviar Dispensa</button>
    </form>
    <div id="listaDispensas"></div>
  </section>

  <!-- RECIBOS -->
  <section id="recibos">
    <h2>Submissão de Recibos</h2>
    <form id="reciboForm">
      <label>Nº do Jogo</label>
      <input type="text" id="numeroJogo" required>

      <div class="table-wrap">
        <table id="tabelaRecibos">
          <thead>
            <tr>
              <th>Cargo</th>
              <th>Nome</th>
              <th>Prémio (€)</th>
              <th>Deslocação (€)</th>
              <th>Diversos (€)</th>
              <th>Total (€)</th>
              <th>Remover</th>
            </tr>
          </thead>
          <tbody id="tabelaRecibosBody">
            <tr>
              <td data-label="Cargo">Árbitro Principal</td>
              <td data-label="Nome"><input type="text" class="nome"></td>
              <td data-label="Prémio"><input type="number" class="premio" step="0.01" min="0"></td>
              <td data-label="Deslocação"><input type="number" class="deslocacao" step="0.01" min="0"></td>
              <td data-label="Diversos"><input type="number" class="diversos" step="0.01" min="0"></td>
              <td data-label="Total" class="total">0,00</td>
              <td data-label="Remover"><button type="button" class="btn-remover">X</button></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Total Geral (€): <span id="totalGeral">0,00</span></h3>

      <label>Upload Recibo (PDF ou Imagem)</label>
      <input type="file" id="ficheiroRecibo" accept=".pdf,.jpg,.jpeg,.png">

      <button type="button" onclick="enviarRecibo()">Enviar Recibo</button>
    </form>

    <div id="listaRecibos"></div>
  </section>

  <!-- COMUNICADOS -->
  <section id="comunicados">
    <h2>Comunicados</h2>
    <div id="listaComunicados">—</div>
  </section>

  <!-- CALENDÁRIO -->
  <section id="calendario">
    <h2>Calendário ABVC</h2>
    <iframe src="https://www.fpb.pt/calendario/associacao_17/?associacao=17&epoca=2025/2026" style="width:100%;height:600px;border:0"></iframe>
  </section>

  <!-- CONTACTOS -->
  <section id="contactos">
    <h2>Contactos</h2>
    <p><a href="https://wa.me/351926166077" target="_blank">Enviar WhatsApp</a></p>

    <form id="emailForm">
      <label>Seu Email</label>
      <input type="email" id="emailRemetente">

      <label>Assunto</label>
      <input type="text" id="assuntoEmail">

      <label>Mensagem</label>
      <textarea id="mensagemEmail"></textarea>

      <button type="button" onclick="enviarEmail()">Enviar Email</button>
    </form>
  </section>
</div>

<footer>
  <span>R. Conselheiro Arnaldo Norton de Matos 31, 4990-081 Pte. de Lima</span>
  <span><a class="footer-link" href="admin.html">Admin</a></span>
</footer>

<!-- Carregar biblioteca Supabase (deve vir antes de tudo que usa supabase) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Inicialização correta evitando shadowing / TDZ -->
<script>
  const SUPABASE_URL = 'https://prwhifyewscielsopluj.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByd2hpZnlld3NjaWVsc29wbHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzA2MzEsImV4cCI6MjA3ODYwNjYzMX0.N8Op_2iUwRFd71YTninoztaInQtVLEnVIwbi2nIHkKg';

  // garantir que a lib está carregada
  if (!window.supabase || typeof window.supabase.createClient !== "function") {
    console.error("Supabase library not ready — verifique se o <script src> está antes deste código.");
  } else {
    // cria o client corretamente
    window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log("Supabase Client OK");
  }
</script>
  
function showSection(id) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
  if (id === 'dispensas') carregarListaDispensas();
  if (id === 'recibos') carregarListaRecibos();
}

function atualizarTotais() {
  let totalGeral = 0;
  document.querySelectorAll('#tabelaRecibosBody tr').forEach(row => {
    const premio = parseFloat((row.querySelector('.premio').value || 0).toString().replace(',', '.')) || 0;
    const desloc = parseFloat((row.querySelector('.deslocacao').value || 0).toString().replace(',', '.')) || 0;
    const diversos = parseFloat((row.querySelector('.diversos').value || 0).toString().replace(',', '.')) || 0;
    const total = premio + desloc + diversos;
    row.querySelector('.total').textContent = total.toFixed(2).replace('.', ',');
    totalGeral += total;
  });
  document.getElementById('totalGeral').textContent = totalGeral.toFixed(2).replace('.', ',');
}

document.addEventListener('input', e => {
  if (e.target.matches('#tabelaRecibosBody input')) atualizarTotais();
});

document.addEventListener('click', e => {
  if (e.target.classList.contains('btn-remover')) {
    e.target.closest('tr').remove();
    atualizarTotais();
  }
});

/* DISPENSAS */
async function enviarDispensa() {
  const nome = document.getElementById('nomeDispensa').value.trim();
  const dataInicio = document.getElementById('dataInicio').value;
  const dataFim = document.getElementById('dataFim').value;
  const periodo = document.getElementById('periodo').value;
  const motivo = document.getElementById('motivo').value.trim();

  if (!nome || !dataInicio || !dataFim) return alert('Preencha os campos obrigatórios.');
  if (new Date(dataFim) < new Date(dataInicio)) return alert('Data final não pode ser anterior à inicial.');

  const { error } = await supabaseClient.from('dispensas').insert([{ nome, data_inicio: dataInicio, data_fim: dataFim, periodo, motivo }]);

  if (error) return alert('Erro: ' + error.message);

  alert('Dispensa enviada!');
  document.getElementById('dispensaForm').reset();
  carregarListaDispensas();
}

async function carregarListaDispensas() {
  const div = document.getElementById('listaDispensas');

  const { data, error } = await supabaseClient.from('dispensas').select('*').order('id', { ascending: false }).limit(200);

  if (error) return div.innerHTML = '<p>Erro ao carregar.</p>';
  if (!data || data.length === 0) return div.innerHTML = '<p>Sem dispensas.</p>';

  let html = '<div class="table-wrap"><table><thead><tr><th>Nome</th><th>Início</th><th>Fim</th><th>Período</th><th>Motivo</th></tr></thead><tbody>';
  data.forEach(d => {
    html += `<tr>
              <td>${d.nome}</td>
              <td>${d.data_inicio || ''}</td>
              <td>${d.data_fim || ''}</td>
              <td>${d.periodo || ''}</td>
              <td>${d.motivo || ''}</td>
            </tr>`;
  });
  html += '</tbody></table></div>';
  div.innerHTML = html;
}

/* RECIBOS */
async function enviarRecibo() {
  const numeroJogo = document.getElementById('numeroJogo').value.trim();
  if (!numeroJogo) return alert('Insira o número do jogo.');

  const rows = [...document.querySelectorAll('#tabelaRecibosBody tr')];
  const arbitros = [];
  let totalGeral = 0;

  rows.forEach(r => {
    const nome = r.querySelector('.nome').value.trim();
    if (!nome) return;

    const premio = parseFloat((r.querySelector('.premio').value || 0).replace(',', '.')) || 0;
    const desloc = parseFloat((r.querySelector('.deslocacao').value || 0).replace(',', '.')) || 0;
    const diversos = parseFloat((r.querySelector('.diversos').value || 0).replace(',', '.')) || 0;
    const total = premio + desloc + diversos;

    arbitros.push({ cargo: r.children[0].innerText, nome, premio, desloc, diversos, total });
    totalGeral += total;
  });

  let ficheiroUrl = null;
  const ficheiro = document.getElementById('ficheiroRecibo').files[0];

  if (ficheiro) {
    const safeName = `${Date.now()}_${ficheiro.name.replace(/\s+/g, '_')}`;
    const { error: upErr } = await supabaseClient.storage.from('recibos').upload(`public/${safeName}`, ficheiro);

    if (upErr) return alert('Erro upload: ' + upErr.message);

    const { data: urlData } = await supabaseClient.storage.from('recibos').getPublicUrl(`public/${safeName}`);
    ficheiroUrl = urlData?.publicUrl || null;
  }

  const { error } = await supabaseClient.from('recibos').insert([{ numero_jogo: numeroJogo, arbitros, total_geral: totalGeral, ficheiro: ficheiroUrl }]);

  if (error) return alert('Erro: ' + error.message);

  alert('Recibo enviado!');
  document.getElementById('reciboForm').reset();
  atualizarTotais();
  carregarListaRecibos();
}

async function carregarListaRecibos() {
  const div = document.getElementById('listaRecibos');
  const { data, error } = await supabaseClient.from('recibos').select('*').order('id', { ascending: false }).limit(200);

  if (error) return div.innerHTML = '<p>Erro ao carregar.</p>';
  if (!data || data.length === 0) return div.innerHTML = '<p>Sem recibos.</p>';

  let html = '';

  data.forEach(r => {
    html += `<div style="border:1px solid #ccc;padding:6px;margin:6px 0;border-radius:6px">
                <strong>Jogo Nº:</strong> ${r.numero_jogo}
                | <strong>Total Geral:</strong> ${r.total_geral.toFixed(2).replace('.', ',')} €
                ${r.ficheiro ? ` | <a href="${r.ficheiro}" target="_blank">Ver Ficheiro</a>` : ''}
                <ul>
                  ${r.arbitros.map(a => `<li>${a.cargo}: ${a.nome} — Total: ${a.total.toFixed(2).replace('.', ',')} €</li>`).join('')}
                </ul>
            </div>`;
  });

  div.innerHTML = html;
}

/* COMUNICADOS */
async function carregarComunicados() {
  const div = document.getElementById('listaComunicados');
  const { data, error } = await supabaseClient.from('comunicados').select('*').order('id', { ascending: false }).limit(50);

  if (error) return div.innerHTML = '<p>Erro ao carregar comunicados.</p>';
  if (!data || data.length === 0) return div.innerHTML = '<p>Sem comunicados.</p>';

  let html = '<ul>';
  data.forEach(c => {
    html += `<li><strong>${c.titulo}</strong> (${c.data})<br>${c.mensagem}</li>`;
  });
  html += '</ul>';

  div.innerHTML = html;
}

/* EMAIL */
function enviarEmail() {
  const email = document.getElementById('emailRemetente').value.trim();
  const assunto = document.getElementById('assuntoEmail').value.trim();
  const mensagem = document.getElementById('mensagemEmail').value.trim();

  if (!email || !assunto || !mensagem) return alert('Preencha todos os campos');

  alert('Email enviado (simulação)');
  document.getElementById('emailForm').reset();
}

/* INIT */
document.addEventListener('DOMContentLoaded', () => {
  showSection('home');
  carregarListaDispensas();
  carregarListaRecibos();
  carregarComunicados();
});
</script>

</body>
</html>
