<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CAD ABVC - Conselho de Arbitragem</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/supabase.min.js"></script>

<style>
:root{--accent:#000}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#000;line-height:1.4}
nav{display:flex;gap:.5rem;justify-content:center;background:#222;padding:8px;flex-wrap:wrap}
nav a{color:#fff;text-decoration:none;padding:.6rem .8rem;font-weight:700;border-radius:6px;cursor:pointer}
nav a:hover{background:#333}
.container{max-width:1100px;margin:14px auto;padding:0 12px}
.home-img{width:100%;height:auto;border-radius:6px;margin-top:10px}
section{display:none;padding:12px 0}
section.active{display:block}
form{background:#f8f8f8;padding:12px;border-radius:8px;margin-bottom:12px}
label{display:block;margin-top:8px;font-weight:600}
input[type="text"], input[type="date"], input[type="email"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;margin-top:6px}
textarea{min-height:80px}
button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;margin-top:10px}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
.total{font-weight:700}
footer{background:#000;color:#fff;padding:10px 12px;display:flex;justify-content:space-between;flex-wrap:wrap;font-size:0.9rem}
.footer-link{color:#fff;text-decoration:none}

@media(max-width:700px){
  nav{padding:8px}
  table, thead, tbody, th, td, tr{display:block}
  tr{margin-bottom:12px;border:1px solid #eee;padding:8px}
  td{border:none;padding-left:50%;position:relative;text-align:left}
  td::before{content:attr(data-label);position:absolute;left:8px;width:45%;font-weight:700}
}
</style>
</head>
<body>

<nav>
  <a onclick="showSection('home')">Home</a>
  <a onclick="showSection('dispensas')">Dispensas</a>
  <a onclick="showSection('recibos')">Recibos</a>
  <a onclick="showSection('comunicados')">Comunicados</a>
  <a onclick="showSection('calendario')">Calendário ABVC</a>
  <a onclick="showSection('contactos')">Contactos</a>
</nav>

<div class="container">

  <!-- HOME -->
  <section id="home" class="active">
    <img src="abvc_cad.png" alt="AB Viana do Castelo" class="home-img">
    <h2>Bem-vindo ao CAD da ABVC</h2>
    <p>Use o menu para registar dispensas, submeter recibos e consultar o calendário.</p>
  </section>

  <!-- DISPENSAS -->
  <section id="dispensas">
    <h2>Registo de Dispensas</h2>
    <form id="dispensaForm">
      <label>Nome</label>
      <input type="text" id="nomeDispensa" required>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <label>Data Inicial</label>
          <input type="date" id="dataInicio" required>
        </div>
        <div>
          <label>Data Final</label>
          <input type="date" id="dataFim" required>
        </div>
      </div>
      <label>Período</label>
      <select id="periodo" required>
        <option value="Integral">Integral</option>
        <option value="Manhã">Parte da Manhã</option>
        <option value="Tarde">Parte da Tarde</option>
        <option value="Noite">Parte da Noite</option>
      </select>
      <label>Motivo (opcional)</label>
      <textarea id="motivo"></textarea>
      <button type="button" onclick="enviarDispensa()">Enviar Dispensa</button>
    </form>
    <div id="listaDispensas"></div>
  </section>

  <!-- RECIBOS -->
  <section id="recibos">
    <h2>Submissão de Recibos</h2>
    <form id="reciboForm">
      <label>Nº do Jogo</label>
      <input type="text" id="numeroJogo" required>

      <div class="table-wrap">
        <table id="tabelaRecibos">
          <thead>
            <tr>
              <th>Cargo</th>
              <th>Nome</th>
              <th>Prémio (€)</th>
              <th>Deslocação (€)</th>
              <th>Diversos (€)</th>
              <th>Total (€)</th>
            </tr>
          </thead>
          <tbody id="tabelaRecibosBody">
            <tr>
              <td data-label="Cargo">Árbitro Principal</td>
              <td data-label="Nome"><input type="text" class="nome"></td>
              <td data-label="Prémio"><input type="number" class="premio" step="0.01" min="0"></td>
              <td data-label="Deslocação"><input type="number" class="deslocacao" step="0.01" min="0"></td>
              <td data-label="Diversos"><input type="number" class="diversos" step="0.01" min="0"></td>
              <td data-label="Total" class="total">0,00</td>
            </tr>
            <tr>
              <td data-label="Cargo">Árbitro Auxiliar</td>
              <td data-label="Nome"><input type="text" class="nome"></td>
              <td data-label="Prémio"><input type="number" class="premio" step="0.01" min="0"></td>
              <td data-label="Deslocação"><input type="number" class="deslocacao" step="0.01" min="0"></td>
              <td data-label="Diversos"><input type="number" class="diversos" step="0.01" min="0"></td>
              <td data-label="Total" class="total">0,00</td>
            </tr>
            <tr>
              <td data-label="Cargo">Marcador</td>
              <td data-label="Nome"><input type="text" class="nome"></td>
              <td data-label="Prémio"><input type="number" class="premio" step="0.01" min="0"></td>
              <td data-label="Deslocação"><input type="number" class="deslocacao" step="0.01" min="0"></td>
              <td data-label="Diversos"><input type="number" class="diversos" step="0.01" min="0"></td>
              <td data-label="Total" class="total">0,00</td>
            </tr>
            <tr>
              <td data-label="Cargo">Operador 24"</td>
              <td data-label="Nome"><input type="text" class="nome"></td>
              <td data-label="Prémio"><input type="number" class="premio" step="0.01" min="0"></td>
              <td data-label="Deslocação"><input type="number" class="deslocacao" step="0.01" min="0"></td>
              <td data-label="Diversos"><input type="number" class="diversos" step="0.01" min="0"></td>
              <td data-label="Total" class="total">0,00</td>
            </tr>
            <tr>
              <td data-label="Cargo">Cronometrista</td>
              <td data-label="Nome"><input type="text" class="nome"></td>
              <td data-label="Prémio"><input type="number" class="premio" step="0.01" min="0"></td>
              <td data-label="Deslocação"><input type="number" class="deslocacao" step="0.01" min="0"></td>
              <td data-label="Diversos"><input type="number" class="diversos" step="0.01" min="0"></td>
              <td data-label="Total" class="total">0,00</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Total Geral (€): <span id="totalGeral">0,00</span></h3>
      <label>Upload Recibo (PDF ou Imagem)</label>
      <input type="file" id="ficheiroRecibo" accept=".pdf,.jpg,.jpeg,.png">
      <button type="button" onclick="enviarRecibo()">Enviar Recibo</button>
    </form>
    <div id="listaRecibos"></div>
  </section>

  <!-- COMUNICADOS -->
  <section id="comunicados">
    <h2>Comunicados</h2>
    <div id="listaComunicados">—</div>
  </section>

  <!-- CALENDÁRIO -->
  <section id="calendario">
    <h2>Calendário ABVC</h2>
    <iframe src="https://www.fpb.pt/calendario/associacao_17/?associacao=17&epoca=2025/2026" style="width:100%;height:600px;border:0"></iframe>
  </section>

  <!-- CONTACTOS -->
  <section id="contactos">
    <h2>Contactos</h2>
    <p><a href="https://wa.me/351926166077" target="_blank">Enviar WhatsApp</a></p>
    <form id="emailForm">
      <label>Seu Email</label>
      <input type="email" id="emailRemetente">
      <label>Assunto</label>
      <input type="text" id="assuntoEmail">
      <label>Mensagem</label>
      <textarea id="mensagemEmail"></textarea>
      <button type="button" onclick="enviarEmail()">Enviar Email</button>
    </form>
  </section>

</div>

<footer>
  <span>R. Conselheiro Arnaldo Norton de Matos 31, 4990-081 Pte. de Lima</span>
  <span><a class="footer-link" href="admin.html">Admin</a></span>
</footer>

<script>
/* ---------- Supabase ---------- */
const SUPABASE_URL = 'https://prwhifyewscielsopluj.supabase.co';
const SUPABASE_KEY = 'SEU_SUPABASE_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- Navegação ---------- */
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
  if(id==='dispensas') carregarListaDispensas();
  if(id==='recibos') carregarListaRecibos();
}

/* ---------- Totais e listeners ---------- */
function atualizarTotais(){
  let totalGeral = 0;
  document.querySelectorAll('#tabelaRecibosBody tr').forEach(row => {
    const premio = parseFloat((row.querySelector('.premio').value||0).toString().replace(',', '.')) || 0;
    const desloc = parseFloat((row.querySelector('.deslocacao').value||0).toString().replace(',', '.')) || 0;
    const diversos = parseFloat((row.querySelector('.diversos').value||0).toString().replace(',', '.')) || 0;
    const total = premio+desloc+diversos;
    row.querySelector('.total').textContent = total.toFixed(2).replace('.',',');
    totalGeral += total;
  });
  document.getElementById('totalGeral').textContent = totalGeral.toFixed(2).replace('.',',');
}

document.addEventListener('input', (e)=>{
  if(e.target.matches('#tabelaRecibosBody input.premio,#tabelaRecibosBody input.deslocacao,#tabelaRecibosBody input.diversos')){
    atualizarTotais();
  }
});

/* ---------- DISPENSAS ---------- */
async function enviarDispensa(){
  const nome = document.getElementById('nomeDispensa').value.trim();
  const data_inicio = document.getElementById('dataInicio').value;
  const data_fim = document.getElementById('dataFim').value;
  const periodo = document.getElementById('periodo').value;
  const motivo = document.getElementById('motivo').value.trim();
  if(!nome||!data_inicio||!data_fim){ alert('Preencha os campos obrigatórios.'); return; }
  if(new Date(data_fim)<new Date(data_inicio)){ alert('Data final não pode ser anterior à inicial.'); return; }
  const { error } = await supabase.from('dispensas').insert([{nome,data_inicio,data_fim,periodo,motivo}]);
  if(error){ alert('Erro: '+error.message); return; }
  alert('Dispensa enviada!');
  document.getElementById('dispensaForm').reset();
  carregarListaDispensas();
}

async function carregarListaDispensas(){
  const { data, error } = await supabase.from('dispensas').select('*').order('id',{ascending:false}).limit(200);
  const div = document.getElementById('listaDispensas');
  if(error){ div.innerHTML='<p>Erro ao carregar dispensas.</p>'; return; }
  if(!data||data.length===0){ div.innerHTML='<p>Sem dispensas registadas.</p>'; return; }
  let html='<div class="table-wrap"><table><thead><tr><th>Nome</th><th>Início</th><th>Fim</th><th>Período</th><th>Motivo</th></tr></thead><tbody>';
  data.forEach(d=>{
    html+=`<tr><td data-label="Nome">${escapeHtml(d.nome)}</td><td data-label="Início">${d.data_inicio||''}</td><td data-label="Fim">${d.data_fim||''}</td><td data-label="Período">${escapeHtml(d.periodo||'')}</td><td data-label="Motivo">${escapeHtml(d.motivo||'')}</td></tr>`;
  });
  html+='</tbody></table></div>';
  div.innerHTML=html;
}

/* ---------- RECIBOS ---------- */
async function enviarRecibo(){
  const numeroJogo = document.getElementById('numeroJogo').value.trim();
  if(!numeroJogo){ alert('Insira o número do jogo.'); return; }
  const rows = [...document.querySelectorAll('#tabelaRecibosBody tr')];
  const arbitros=[];
  let total=0;
  rows.forEach(r=>{
    const nome = r.querySelector('.nome').value.trim();
    const premio = parseFloat((r.querySelector('.premio').value||0).toString().replace(',','.'))||0;
    const desloc = parseFloat((r.querySelector('.deslocacao').value||0).toString().replace(',','.'))||0;
    const diversos = parseFloat((r.querySelector('.diversos').value||0).toString().replace(',','.'))||0;
    const t = premio+desloc+diversos;
    if(nome) arbitros.push({cargo:r.children[0].innerText,nome,premio,desloc,diversos,total:t});
    total+=t;
 
