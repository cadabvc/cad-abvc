<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin CAD ABVC</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/supabase.min.js"></script>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#000}
nav{display:flex;gap:.5rem;justify-content:center;background:#222;padding:8px;flex-wrap:wrap}
nav a{color:#fff;text-decoration:none;padding:.6rem .8rem;font-weight:700;border-radius:6px;cursor:pointer}
nav a:hover{background:#333}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
h2{margin-top:0}
.table-wrap{overflow-x:auto;margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
th{background:#222;color:#fff}
button{background:#222;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
button:hover{background:#333}
</style>
</head>
<body>

<nav>
  <a onclick="showSection('dispensas')">Dispensas</a>
  <a onclick="showSection('recibos')">Recibos</a>
</nav>

<div class="container">

  <!-- DISPENSAS ADMIN -->
  <section id="dispensas">
    <h2>Dispensas Registradas</h2>
    <div id="adminDispensas"></div>
  </section>

  <!-- RECIBOS ADMIN -->
  <section id="recibos" style="display:none">
    <h2>Recibos Submetidos</h2>
    <div id="adminRecibos"></div>
  </section>

</div>

<script>
/* ---------- Supabase ---------- */
const SUPABASE_URL = 'https://prwhifyewscielsopluj.supabase.co';
const SUPABASE_KEY = 'SEU_SUPABASE_SERVICE_KEY'; // usar service role key para admin
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- Navegação ---------- */
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==='dispensas') carregarDispensasAdmin();
  if(id==='recibos') carregarRecibosAdmin();
}

/* ---------- Escapar HTML ---------- */
function escapeHtml(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

/* ---------- DISPENSAS ADMIN ---------- */
async function carregarDispensasAdmin(){
  const { data, error } = await supabase.from('dispensas').select('*').order('id',{ascending:false}).limit(500);
  const div = document.getElementById('adminDispensas');
  if(error){ div.innerHTML='<p>Erro ao carregar dispensas.</p>'; return; }
  if(!data||data.length===0){ div.innerHTML='<p>Sem dispensas.</p>'; return; }

  let html='<div class="table-wrap"><table><thead><tr><th>ID</th><th>Nome</th><th>Início</th><th>Fim</th><th>Período</th><th>Motivo</th><th>Criado Em</th></tr></thead><tbody>';
  data.forEach(d=>{
    html+=`<tr>
      <td>${d.id}</td>
      <td>${escapeHtml(d.nome)}</td>
      <td>${d.data_inicio||''}</td>
      <td>${d.data_fim||''}</td>
      <td>${escapeHtml(d.periodo||'')}</td>
      <td>${escapeHtml(d.motivo||'')}</td>
      <td>${d.criado_em?new Date(d.criado_em).toLocaleString():""}</td>
    </tr>`;
  });
  html+='</tbody></table></div>';
  div.innerHTML=html;
}

/* ---------- RECIBOS ADMIN ---------- */
async function carregarRecibosAdmin(){
  const { data, error } = await supabase.from('recibos').select('*').order('id',{ascending:false}).limit(500);
  const div = document.getElementById('adminRecibos');
  if(error){ div.innerHTML='<p>Erro ao carregar recibos.</p>'; return; }
  if(!data||data.length===0){ div.innerHTML='<p>Sem recibos.</p>'; return; }

  let html='<div class="table-wrap"><table><thead><tr><th>ID</th><th>Número Jogo</th><th>Árbitros</th><th>Total Geral (€)</th><th>Ficheiro</th><th>Criado Em</th></tr></thead><tbody>';
  data.forEach(r=>{
    const arbHtml = r.arbitros.map(a=>`${escapeHtml(a.cargo)}: ${escapeHtml(a.nome)} - Total: ${a.total.toFixed(2).replace('.',',')}€`).join('<br>');
    let fileLink = r.foto_path ? `<a href="https://prwhifyewscielsopluj.supabase.co/storage/v1/object/public/recibos/${encodeURIComponent(r.foto_path)}" target="_blank">Ver</a>` : '-';
    html+=`<tr>
      <td>${r.id}</td>
      <td>${escapeHtml(r.numero_jogo)}</td>
      <td>${arbHtml}</td>
      <td>${r.total.toFixed(2).replace('.',',')}</td>
      <td>${fileLink}</td>
      <td>${r.criado_em?new Date(r.criado_em).toLocaleString():""}</td>
    </tr>`;
  });
  html+='</tbody></table></div>';
  div.innerHTML=html;
}

/* ---------- Inicial ---------- */
carregarDispensasAdmin();
</script>

</body>
</html>
